---
title: "Transportation GEO Section 1"
author: "Tianyu Su"
date: "8/10/2019"
output: 
  powerpoint_presentation:
    reference_doc: /Users/sutianyu/Dropbox (MIT)/06_MITOS/transportation-part-two/presentations/mitos_markdown_ppt_template.pptx
    slide_level: 2 # use this to override default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "/Users/sutianyu/Dropbox (MIT)/06_mitos/RStudio Projects/transportation-part-two")
```

```{r, include=FALSE}
# load libraries

library(here)

library(tidyverse)
library(ggplot2)
library(ggrepel)
library(ggthemes)
library(dplyr)
library(sf)
library(data.table)
library(lubridate)

library(maps)
library(mapdeck)
library(leaflet)
library(ggmap)
library(tmap)

library(mapview)
library(webshot)
library(htmlwidgets)
library(rbokeh)
library(rio)
# install_formats()
# webshot::install_phantomjs()

# for dot-density map
library(maptools)
library(rgeos)
library(rgdal)
library(ggthemes)

# for isochrones
library(geojsonio)

```

```{r, include=FALSE}

geo_table_sf <- st_read("proc/geo_table/geo_table.shp") %>%
  mutate(count = as.numeric(count))

geo_table_sf


geo_bg_all <- st_read("proc/geo_table/geo_block_all.shp")

nrow(geo_table_sf)
nrow(geo_bg_all)

metadata <- read.csv("proc/geo_table/geo_table_metadata.csv")

people_table <- read.csv("proc/people_table/hr-people-small-table.csv")

nrow(people_table)
head(people_table)

# exclude students
unique(pull(people_table, affiliation))

people_table_em_fa <- people_table %>%
  filter(!(affiliation == "Student"))

nrow(people_table_em_fa)

people_geoid <- read_csv("raw/raw-geospatial/all_transportation_and_hr_mit_ids_with_geoid.csv") %>%
  filter((!is.na(GEOID_FY2019)) | (!is.na(GEOID_FY2018)) | (!is.na(GEOID_FY2017)) | (!is.na(GEOID_FY2016)))

MIT_long <- -71.093510
MIT_lat <- 42.358983

```


```{r, include=FALSE}
# load boundary for large scale map (country boundary, state boundary, waterbody)

boundary_state <- st_read("raw/raw-geospatial/BOUNDARY_StateBoundary/tl_2018_us_state.shp")

# prepare the state label file
library(rgeos)

centroid <- function(sf) {
  centroid <- st_as_sf(gCentroid(as(sf, 'Spatial'),byid=TRUE))
}

state_centroids <- centroid(boundary_state$geometry) %>%
  mutate(geoid = boundary_state$GEOID) %>%
  mutate(name = boundary_state$NAME)

state_centroids
plot(state_centroids)

coord <- st_coordinates(state_centroids)

state_centroids <- cbind(state_centroids, coord) %>%
              st_set_geometry(NULL)

# load country boundary and waterbody
boundary_canada <- st_read("raw/raw-geospatial/BOUNDARY_Canada/gpr_000a11a_e.shp")
boundary_water <- st_read("raw/raw-geospatial/BOUNDARY_Water/ne_10m_ocean.shp")

```


```{r, include=FALSE}
# load boundary for medium and small scale map (city boundary, waterbody)

boundary_city <- st_read("raw/raw-geospatial/BOUNDARY_City/tl_2018_us_county.shp")

# prepare the city label file
library(rgeos)

centroid <- function(sf) {
  centroid <- st_as_sf(gCentroid(as(sf, 'Spatial'),byid=TRUE))
}

city_centroids <- centroid(boundary_city$geometry) %>%
  mutate(geoid = boundary_city$GEOID) %>%
  mutate(name = boundary_city$NAME)

city_centroids
plot(city_centroids)

coord <- st_coordinates(city_centroids)

city_centroids <- cbind(city_centroids, coord) %>%
              st_set_geometry(NULL)

head(city_centroids)

# load waterbody of MA, NH, RI, CT
boundary_water_mass <- st_read("raw/raw-geospatial/BOUNDARY_Waterbody/waterbody_mass.shp")
boundary_water_nhri <- st_read("raw/raw-geospatial/BOUNDARY_Waterbody/waterbody_NH&RI.shp")
boundary_water_ct <- st_read("raw/raw-geospatial/BOUNDARY_Waterbody/waterbody_CT.shp")

# load highway of MA
highway_mass <- st_read("raw/raw-geospatial/MassDOT_Roads_SHP/EOTMAJROADS_RTE_MAJOR.shp") %>%
  st_transform(4326)

```


```{r, include=FALSE}
# read in cycling isochrones

cycling_15 <- geojson_read(("proc/isochrones/isochrone_cycling_15.geojson"), method = "web", parse = FALSE, what = "sp")
plot(cycling_15)
cycling_15_sf <- st_as_sf(cycling_15)

cycling_30 <- geojson_read(("proc/isochrones/isochrone_cycling_30.geojson"), method = "web", parse = FALSE, what = "sp")
plot(cycling_30)
cycling_30_sf <- st_as_sf(cycling_30)

cycling_45 <- geojson_read(("proc/isochrones/isochrone_cycling_45.geojson"), method = "web", parse = FALSE, what = "sp")
plot(cycling_45)
cycling_45_sf <- st_as_sf(cycling_45)

cycling_60 <- geojson_read(("proc/isochrones/isochrone_cycling_60.geojson"), method = "web", parse = FALSE, what = "sp")
plot(cycling_60)
cycling_60_sf <- st_as_sf(cycling_60)

```


```{r, include=FALSE}
# read in driving isochrones

driving_15 <- geojson_read(("proc/isochrones/isochrone_driving_15.geojson"), method = "web", parse = FALSE, what = "sp")
plot(driving_15)
driving_15_sf <- st_as_sf(driving_15)

driving_30 <- geojson_read(("proc/isochrones/isochrone_driving_30.geojson"), method = "web", parse = FALSE, what = "sp")
plot(driving_30)
driving_30_sf <- st_as_sf(driving_30)

driving_45 <- geojson_read(("proc/isochrones/isochrone_driving_45.geojson"), method = "web", parse = FALSE, what = "sp")
plot(driving_45)
driving_45_sf <- st_as_sf(driving_45)

driving_60 <- geojson_read(("proc/isochrones/isochrone_driving_60.geojson"), method = "web", parse = FALSE, what = "sp")
plot(driving_60)
driving_60_sf <- st_as_sf(driving_60)

```


```{r, include=FALSE}
# read in walking isochrones

walking_15 <- geojson_read(("proc/isochrones/isochrone_walking_15.geojson"), method = "web", parse = FALSE, what = "sp")
plot(walking_15)
walking_15_sf <- st_as_sf(walking_15)

walking_30 <- geojson_read(("proc/isochrones/isochrone_walking_30.geojson"), method = "web", parse = FALSE, what = "sp")
plot(walking_30)
walking_30_sf <- st_as_sf(walking_30)

walking_45 <- geojson_read(("proc/isochrones/isochrone_walking_45.geojson"), method = "web", parse = FALSE, what = "sp")
plot(walking_45)
walking_45_sf <- st_as_sf(walking_45)

walking_60 <- geojson_read(("proc/isochrones/isochrone_walking_60.geojson"), method = "web", parse = FALSE, what = "sp")
plot(walking_60)
walking_60_sf <- st_as_sf(walking_60)

```


```{r, include=FALSE}
# generate centroid points of blocks

library(rgeos)

centroid <- function(sf) {
  centroid <- st_as_sf(gCentroid(as(sf, 'Spatial'),byid=TRUE))
}

block_centroids <- centroid(geo_table_sf$geometry) %>%
  mutate(geoid = geo_table_sf$geoid)

block_centroids
plot(block_centroids)

```


```{r, include=FALSE}
# select blocks whose centroids are in isochrone-driving 60 (medium scale) and set bounding box

block_centroids <- block_centroids %>% 
  st_set_crs(4326)

block_centroids_in <- st_join(block_centroids, driving_60_sf, left = FALSE)

geoid_60 <- unique(pull(block_centroids_in, geoid))
head(geoid_60,5)

geo_table_60_sf <- geo_table_sf %>%
  filter(geoid %in% geoid_60)

```

```{r, include=FALSE}

bb_bg = st_bbox(driving_60_sf)

bb_bg[1]
bb_bg[2]
bb_bg[3]
bb_bg[4]

```


```{r, include=FALSE}
# select blocks whose centroids are in isochrone-driving 30 (small scale) and set bounding box

block_centroids <- block_centroids %>% 
  st_set_crs(4326)

block_centroids_in <- st_join(block_centroids, driving_30_sf, left = FALSE)

geoid_30 <- unique(pull(block_centroids_in, geoid))
head(geoid_30,5)

geo_table_30_sf <- geo_table_sf %>%
  filter(geoid %in% geoid_30)

```

```{r, include=FALSE}

bb_bg = st_bbox(driving_30_sf)

bb_bg[1]
bb_bg[2]
bb_bg[3]
bb_bg[4]

```


```{r, include=FALSE}
# prepare 2018 data (employees/faculties/students)
# prepare 2018 data (employees/faculties)

head(people_table)
head(people_geoid)

people_geoid_2018 <- people_geoid %>%
  dplyr::select(MITID,
                GEOID_FY2018) %>%
  rename(mit_id = MITID) %>%
  rename(geoid = GEOID_FY2018)

people_table_2018 <- people_table %>%
  filter(parking_year == 2018) %>%
  left_join(people_geoid_2018, by = 'mit_id') 

people_table_2018 %>%
  filter((!is.na(geoid)))

# 27187/42020 = 64.7% of 2018 employees/faculties/students have geoid

people_table_2018

people_table_2018 %>%
  filter((!is.na(geoid))) %>%
  group_by(geoid) %>%
  summarise(count_2018 = n()) %>%
  arrange(desc(count_2018))

people_table_2018_ef <- people_table_2018 %>%
  filter((!is.na(geoid))) %>%
  filter(affiliation == "Employee" | affiliation == "Faculty")

people_table_2018_ef

# 12294 of employees/faculties have goeid

people_table_2018_forjoin <- people_table_2018 %>%
  filter((!is.na(geoid))) %>%
  group_by(geoid) %>%
  summarise(count_2018 = n()) %>%
  arrange(desc(count_2018)) 

geo_people_2018 <- geo_table_sf %>%
  inner_join(people_table_2018_forjoin, by = 'geoid') %>%
  mutate(count_2018 = as.numeric(count_2018))

geo_people_2018
class(geo_people_2018)

sum(geo_people_2018$count_2018)

# 26726/27187 = 98.3% of the employees/faculties/students with geoid are in the top 11 state

people_table_2018_ef_forjoin <- people_table_2018_ef %>%
  filter((!is.na(geoid))) %>%
  group_by(geoid) %>%
  summarise(count_2018 = n()) %>%
  arrange(desc(count_2018)) 

geo_people_2018_ef <- geo_table_sf %>%
  inner_join(people_table_2018_ef_forjoin, by = 'geoid') %>%
  mutate(count_2018 = as.numeric(count_2018))

geo_people_2018_ef
class(geo_people_2018_ef)

sum(geo_people_2018_ef$count_2018)

# 12029/12294 = 97.8% of the employees/faculties with geoid are in the top 11 state

```

# prepare permit data
```{r}

permit <- read.csv("proc/permits-processed-permit-letters-person-level.csv")
permit_18 <- permit %>%
  filter(parking_year == "PY18") %>%
  rename(mit_id = accountnumber)

permit_18
# in PY2018, there are 6522 employees/faculty/students have parking permits

people_permit_18 <- permit_18 %>%
  inner_join(people_table_2018_ef, by = "mit_id")

people_permit_18
# in PY2018, there are 4,512 employees/faculty have parking permits and geoid

people_permit_2018_forjoin <- people_permit_18 %>%
  filter((!is.na(geoid))) %>%
  group_by(geoid) %>%
  summarise(count_permit_2018 = n()) %>%
  arrange(desc(count_permit_2018))

people_permit_2018_forjoin
sum(people_permit_2018_forjoin$count_permit_2018)
# in PY2018, there are 4,512 employees/faculty have parking permits and geoid

geo_permit_2018 <- geo_table_sf %>%
  inner_join(people_permit_2018_forjoin, by = 'geoid') %>%
  mutate(count_permit_2018 = as.numeric(count_permit_2018))

geo_permit_2018
sum(geo_permit_2018$count_permit_2018)

# 4501/4512 = 99.8% of the PY2018 permit holders are in the top 11 state

```

```{r, include=FALSE}
# prepare the dataset

geo_table_sf_valid <- geo_table_sf %>%
  filter(!is.na(D_M_Tim)) 

geo_table_sf_valid

geo_table_sf_valid[is.na(geo_table_sf_valid)] <- 1000000

geo_table_sf_valid_permit <- geo_table_sf_valid %>%
  left_join((st_set_geometry(geo_permit_2018, NULL) %>% dplyr::select(geoid, count_permit_2018)), by = 'geoid') 

geo_table_sf_valid_permit

geo_table_sf_valid_permit$count_permit_2018[is.na(geo_table_sf_valid_permit$count_permit_2018)] <- 0

```


```{r}

geo_table_60_sf_full <- geo_table_sf_valid_permit %>%
  filter(geoid %in% geoid_60)

sum(geo_table_60_sf_full$count_permit_2018)
# 4372/4512 = 96.9% of the PY2018 permit holders are in the mid-scale boundary

geo_table_30_sf_full <- geo_table_sf_valid_permit %>%
  filter(geoid %in% geoid_30)

sum(geo_table_30_sf_full$count_permit_2018)
# 3420/4512 = 75.8% of the PY2018 permit holders are in the local-scale boundary

```


******************* SECTION1: DOT DENSITY *******************

******************* dot-density map for large scale *******************


# ```{r, include=FALSE}
# # dot-density map for 2018 (all)
# 
# head(people_table)
# head(people_geoid)
# 
# people_geoid_2018 <- people_geoid %>%
#   dplyr::select(MITID,
#                 GEOID_FY2018) %>%
#   rename(mit_id = MITID) %>%
#   rename(geoid = GEOID_FY2018)
# 
# people_table_2018 <- people_table %>%
#   filter(parking_year == 2018) %>%
#   left_join(people_geoid_2018, by = 'mit_id') 
# 
# people_table_2018 %>%
#   filter((!is.na(geoid)))
# 
# # 27187/42020 = 64.7% of 2018 employees/students have geoid
# 
# people_table_2018
# 
# people_table_2018 %>%
#   filter((!is.na(geoid))) %>%
#   group_by(geoid) %>%
#   summarise(count_2018 = n()) %>%
#   arrange(desc(count_2018))
# 
# people_table_2018 %>%
#   filter((!is.na(geoid))) %>%
#   filter(affiliation == "Employee" | affiliation == "Faculty")
# 
# # 12294 of employees/faculties have goeid
# 
# people_table_2018_forjoin <- people_table_2018 %>%
#   filter((!is.na(geoid))) %>%
#   group_by(geoid) %>%
#   summarise(count_2018 = n()) %>%
#   arrange(desc(count_2018)) 
# 
# geo_people_2018 <- geo_table_sf %>%
#   inner_join(people_table_2018_forjoin, by = 'geoid') %>%
#   mutate(count_2018 = as.numeric(count_2018))
# 
# geo_people_2018
# class(geo_people_2018)
# 
# sum(geo_people_2018$count_2018)
# 
# # 26726/27187 = 98.3% of the employees/students with geoid are in the top 11 state
# 
# geo_people_2018_num <- geo_people_2018 %>%
#   st_set_geometry(NULL) %>%
#   dplyr::select(geoid, count_2018) 
# 
# num.dots <- select(geo_people_2018_num, count_2018)
# 
# num.dots
# 
# geo_people_2018_sp <- as(geo_people_2018, "Spatial")
# class(geo_people_2018_sp)
# 
# sp.dfs <- lapply(names(num.dots), function(x) {
#   dotsInPolys(geo_people_2018_sp, as.integer(num.dots[, x]), f="random")
# })
# 
# dfs <- lapply(sp.dfs, function(x) {
#   data.frame(coordinates(x)[,1:2])
# })
# 
# dots.final <- bind_rows(dfs)
# 
# head(dots.final)
# head(boundary_state)
# 
# people_map_2018_all <- ggplot() +
#   geom_sf(data = boundary_state, fill = "white", color = 'grey', size = 0.5, alpha = 1, show.legend = FALSE) +
#   geom_sf(data = boundary_canada, fill = "white", color = 'grey', size = 0.5, alpha = 1, show.legend = FALSE) +
#   geom_sf(data = boundary_water, fill = "grey50", color = 'grey', size = 0.5, alpha = 1, show.legend = FALSE) +
#   geom_sf(data = geo_people_2018, fill = "white", color = 'white', size = .001, show.legend = TRUE) +
#   coord_sf(xlim = c(-80.42745, -69.8), ylim = c(36.78677, 45.34768)) +
#   geom_point(data = dots.final, aes(x, y), colour = "#007fb0", alpha = 0.05) +
#   geom_label(data = state_centroids, aes(X, Y, label = name), fill = "black", colour = "white", fontface = "bold", label.size = 0.15)
# 
# people_map_2018_all
# 
# ggsave("visual/people_map_2018_all.png", plot = people_map_2018_all, device = NULL, path = NULL,
#   scale = 1, width = 30, height = 30, units = "cm",
#   dpi = 300, limitsize = TRUE)
# 
# ```
# 
# ```{r, include=FALSE}
# # dot-density map for 2018 (permit holders)
# 
# geo_people_2018_num <- geo_table_sf_valid %>%
#   st_set_geometry(NULL) %>%
#   dplyr::select(geoid, count_permit_2018) 
# 
# num.dots <- select(geo_people_2018_num, count_permit_2018)
# 
# num.dots
# 
# geo_people_2018_sp <- as(geo_table_sf_valid, "Spatial")
# class(geo_people_2018_sp)
# 
# sp.dfs <- lapply(names(num.dots), function(x) {
#   dotsInPolys(geo_people_2018_sp, as.integer(num.dots[, x]), f="random")
# })
# 
# dfs <- lapply(sp.dfs, function(x) {
#   data.frame(coordinates(x)[,1:2])
# })
# 
# dots.final <- bind_rows(dfs)
# 
# head(dots.final)
# head(boundary_state)
# 
# people_map_2018_permit <- ggplot() +
#   geom_sf(data = boundary_state, fill = "white", color = 'grey', size = 0.5, alpha = 1, show.legend = FALSE) +
#   geom_sf(data = boundary_canada, fill = "white", color = 'grey', size = 0.5, alpha = 1, show.legend = FALSE) +
#   geom_sf(data = boundary_water, fill = "grey50", color = 'grey', size = 0.5, alpha = 1, show.legend = FALSE) +
#   geom_sf(data = geo_people_2018, fill = "white", color = 'white', size = .001, show.legend = TRUE) +
#   coord_sf(xlim = c(-80.42745, -69.8), ylim = c(36.78677, 45.34768)) +
#   geom_point(data = dots.final, aes(x, y), colour = "purple", alpha = 0.05) +
#   geom_label(data = state_centroids, aes(X, Y, label = name), fill = "black", colour = "white", fontface = "bold", label.size = 0.15)
# 
# people_map_2018_permit
# 
# ggsave("visual/people_map_2018_permit.png", plot = people_map_2018_permit, device = NULL, path = NULL,
#   scale = 1, width = 30, height = 30, units = "cm",
#   dpi = 300, limitsize = TRUE)
# 
# ```
# 
# ```{r, include=FALSE}
# # dot-density map for 2018 (affiliations)
# 
# people_table_2018
# distinct(people_table_2018, affiliation, .keep_all = FALSE)
# 
# people_table_2018 %>%
#   filter((!is.na(geoid)))
# 
# people_table_2018_forjoin_emp <- people_table_2018 %>%
#   filter((!is.na(geoid)) & affiliation == 'Employee') %>%
#   group_by(geoid) %>%
#   summarise(count_2018_emp = n()) %>%
#   arrange(desc(count_2018_emp)) 
# 
# people_table_2018_forjoin_fac <- people_table_2018 %>%
#   filter((!is.na(geoid)) & affiliation == 'Faculty') %>%
#   group_by(geoid) %>%
#   summarise(count_2018_fac = n()) %>%
#   arrange(desc(count_2018_fac)) 
# 
# people_table_2018_forjoin_stu <- people_table_2018 %>%
#   filter((!is.na(geoid)) & affiliation == 'Student') %>%
#   group_by(geoid) %>%
#   summarise(count_2018_stu = n()) %>%
#   arrange(desc(count_2018_stu)) 
# 
# geo_people_2018_aff <- geo_table_sf %>%
#   left_join(people_table_2018_forjoin_emp, by = 'geoid') %>%
#   left_join(people_table_2018_forjoin_fac, by = 'geoid') %>%
#   left_join(people_table_2018_forjoin_stu, by = 'geoid') %>%
#   mutate(count_2018_emp = as.numeric(count_2018_emp)) %>%
#   mutate(count_2018_fac = as.numeric(count_2018_fac)) %>%
#   mutate(count_2018_stu = as.numeric(count_2018_stu))
# 
# geo_people_2018_aff[is.na(geo_people_2018_aff)] <- 0
# 
# sum(geo_people_2018_aff$count_2018_emp) + sum(geo_people_2018_aff$count_2018_fac)
# 
# # 12029/12294 = 97.8% of the employees/faculties with geoid are in the top 11 state
# 
# # build employee dot data
# 
# geo_people_2018_emp <- geo_table_sf %>%
#   inner_join(people_table_2018_forjoin_emp, by = 'geoid') %>%
#   mutate(count_2018_emp = as.numeric(count_2018_emp))
# 
# geo_people_2018_emp_sp <- as(geo_people_2018_emp, "Spatial")
# class(geo_people_2018_emp)
# 
# geo_people_2018_emp_num <- geo_people_2018_emp %>%
#   st_set_geometry(NULL) %>%
#   dplyr::select(geoid, count_2018_emp) 
# 
# num.dots <- select(geo_people_2018_emp_num, count_2018_emp)
# 
# num.dots
# 
# sp.dfs <- lapply(names(num.dots), function(x) {
#   dotsInPolys(geo_people_2018_emp_sp, as.integer(num.dots[, x]), f="random")
# })
# 
# dfs <- lapply(sp.dfs, function(x) {
#   data.frame(coordinates(x)[,1:2])
# })
# 
# dots.final_emp <- bind_rows(dfs)
# 
# head(dots.final_emp)
# 
# # build faculty dot data
# geo_people_2018_fac <- geo_table_sf %>%
#   inner_join(people_table_2018_forjoin_fac, by = 'geoid') %>%
#   mutate(count_2018_fac = as.numeric(count_2018_fac))
# 
# geo_people_2018_fac_sp <- as(geo_people_2018_fac, "Spatial")
# class(geo_people_2018_fac)
# 
# geo_people_2018_fac_num <- geo_people_2018_fac %>%
#   st_set_geometry(NULL) %>%
#   dplyr::select(geoid, count_2018_fac) 
# 
# num.dots <- select(geo_people_2018_fac_num, count_2018_fac)
# 
# num.dots
# 
# sp.dfs <- lapply(names(num.dots), function(x) {
#   dotsInPolys(geo_people_2018_fac_sp, as.integer(num.dots[, x]), f="random")
# })
# 
# dfs <- lapply(sp.dfs, function(x) {
#   data.frame(coordinates(x)[,1:2])
# })
# 
# dots.final_fac <- bind_rows(dfs)
# 
# head(dots.final_fac)
# 
# # build student dot data
# geo_people_2018_stu <- geo_table_sf %>%
#   inner_join(people_table_2018_forjoin_stu, by = 'geoid') %>%
#   mutate(count_2018_stu = as.numeric(count_2018_stu))
# 
# geo_people_2018_stu_sp <- as(geo_people_2018_stu, "Spatial")
# class(geo_people_2018_stu)
# 
# geo_people_2018_stu_num <- geo_people_2018_stu %>%
#   st_set_geometry(NULL) %>%
#   dplyr::select(geoid, count_2018_stu) 
# 
# num.dots <- select(geo_people_2018_stu_num, count_2018_stu)
# 
# num.dots
# 
# sp.dfs <- lapply(names(num.dots), function(x) {
#   dotsInPolys(geo_people_2018_stu_sp, as.integer(num.dots[, x]), f="random")
# })
# 
# dfs <- lapply(sp.dfs, function(x) {
#   data.frame(coordinates(x)[,1:2])
# })
# 
# dots.final_stu <- bind_rows(dfs)
# 
# head(dots.final_stu)
# 
# 
# # create the affiliation dot density map
# people_map_2018_affiliations <- ggplot() +
#   geom_sf(data = boundary_state, fill = "white", color = 'grey', size = 0.5, alpha = 1, show.legend = FALSE) +
#   geom_sf(data = boundary_canada, fill = "white", color = 'grey', size = 0.5, alpha = 1, show.legend = FALSE) +
#   geom_sf(data = geo_people_2018, fill = "white", color = 'white', size = .001, show.legend = TRUE) +
#   geom_sf(data = boundary_water, fill = "grey50", color = 'grey', size = 0.5, alpha = 1, show.legend = FALSE) +
#   coord_sf(xlim = c(-80.42745, -69.8), ylim = c(36.78677, 45.34768)) +
#   geom_point(data = dots.final_emp, aes(x, y, colour = 'employee'), alpha = 0.15) +
#   geom_point(data = dots.final_fac, aes(x, y, colour = 'faculty'), alpha = 0.15) +
#   geom_point(data = dots.final_stu, aes(x, y, colour = 'student'), alpha = 0.10) +
#   scale_color_manual(values = c('student' = '#b62367', 'employee' = '#38835b', 'faculty' = '#e17002')) +
#   geom_label(data = state_centroids, aes(X, Y, label = name), fill = "black", colour = "white", fontface = "bold", label.size = 0.15)
# 
# people_map_2018_affiliations
# 
# ggsave("visual/people_map_2018_affiliations.png", plot = people_map_2018_affiliations, device = NULL, path = NULL,
#   scale = 1, width = 30, height = 30, units = "cm",
#   dpi = 300, limitsize = TRUE)
# 
# # create the affiliation dot density map (only employees and faculties)
# people_map_2018_affiliations_ef <- ggplot() +
#   geom_sf(data = boundary_state, fill = "white", color = 'grey', size = 0.5, alpha = 1, show.legend = FALSE) +
#   geom_sf(data = boundary_canada, fill = "white", color = 'grey', size = 0.5, alpha = 1, show.legend = FALSE) +
#   geom_sf(data = geo_people_2018, fill = "white", color = 'white', size = .001, show.legend = TRUE) +
#   geom_sf(data = boundary_water, fill = "grey50", color = 'grey', size = 0.5, alpha = 1, show.legend = FALSE) +
#   coord_sf(xlim = c(-80.42745, -69.8), ylim = c(36.78677, 45.34768)) +
#   geom_point(data = dots.final_emp, aes(x, y, colour = 'employee'), alpha = 0.15) +
#   geom_point(data = dots.final_fac, aes(x, y, colour = 'faculty'), alpha = 0.15) +
#   scale_color_manual(values = c('employee' = '#38835b', 'faculty' = '#e17002')) +
#   geom_label(data = state_centroids, aes(X, Y, label = name), fill = "black", colour = "white", fontface = "bold", label.size = 0.15)
# 
# people_map_2018_affiliations_ef
# 
# ggsave("visual/people_map_2018_affiliations_ef.png", plot = people_map_2018_affiliations_ef, device = NULL, path = NULL,
#   scale = 1, width = 30, height = 30, units = "cm",
#   dpi = 300, limitsize = TRUE)
# 
# ```

******************* dot-density map for medium scale *******************

```{r, include=FALSE}
# dot-density map for 2018 (all)

head(people_table)
head(people_geoid)

people_geoid_2018 <- people_geoid %>%
  dplyr::select(MITID,
                GEOID_FY2018) %>%
  rename(mit_id = MITID) %>%
  rename(geoid = GEOID_FY2018)

people_table_2018 <- people_table %>%
  filter(parking_year == 2018) %>%
  left_join(people_geoid_2018, by = 'mit_id') 

people_table_2018 %>%
  filter((!is.na(geoid)))

# 27187/42020 = 64.7% of 2018 employees/students have geoid

people_table_2018 %>%
  filter((!is.na(geoid))) %>%
  group_by(geoid) %>%
  summarise(count_2018 = n()) %>%
  arrange(desc(count_2018))

people_table_2018_forjoin <- people_table_2018 %>%
  filter((!is.na(geoid))) %>%
  group_by(geoid) %>%
  summarise(count_2018 = n()) %>%
  arrange(desc(count_2018)) 

geo_people_2018_60 <- geo_table_60_sf %>%
  inner_join(people_table_2018_forjoin, by = 'geoid') %>%
  mutate(count_2018 = as.numeric(count_2018))

geo_people_2018_60
class(geo_people_2018_60)

sum(geo_people_2018_60$count_2018)

# 26726/27187 = 98.3% of the employees/students with geoid are in the top 11 state
# 25696/27187 = 94.5% of the employees/students with geoid live within 1 hour driving area

geo_people_2018_60_num <- geo_people_2018_60 %>%
  st_set_geometry(NULL) %>%
  dplyr::select(geoid, count_2018) 

num.dots <- select(geo_people_2018_60_num, count_2018)

num.dots

geo_people_2018_60_sp <- as(geo_people_2018_60, "Spatial")
class(geo_people_2018_60_sp)

sp.dfs <- lapply(names(num.dots), function(x) {
  dotsInPolys(geo_people_2018_60_sp, as.integer(num.dots[, x]), f="random")
})

dfs <- lapply(sp.dfs, function(x) {
  data.frame(coordinates(x)[,1:2])
})

dots.final <- bind_rows(dfs)

head(dots.final)

people_map_2018_60_all <- ggplot() +
  geom_sf(data = boundary_city, fill = "white", color = 'grey', size = 0.5, alpha = 1, show.legend = FALSE) +
  geom_sf(data = geo_people_2018_60, fill = "white", color = 'white', size = .1, show.legend = TRUE, alpha = 0) +
  geom_sf(data = boundary_water_mass, fill = "grey50", color = 'grey', size = 0.5, alpha = 1, show.legend = FALSE) +
  geom_sf(data = boundary_water_nhri, fill = "grey50", color = 'grey', size = 0.5, alpha = 1, show.legend = FALSE) +
  geom_sf(data = boundary_water_ct, fill = "grey50", color = 'grey', size = 0.5, alpha = 1, show.legend = FALSE) +
  geom_sf(data = highway_mass, fill = "white", color = 'grey', size = 1, alpha = 0, show.legend = FALSE) +
  geom_sf(data = driving_60_sf, fill = "white", color = "#e42f3f", size = 0.5, show.legend = TRUE, alpha = 0) +
  coord_sf(xlim = c(-72.14123, -70.54279 ), ylim = c(41.67098, 43.07718)) +
  geom_point(data = dots.final, aes(x, y), colour = "#007fb0", alpha = 0.10) +
  geom_label(data = city_centroids, aes(X, Y, label = name), fill = "black", colour = "white", fontface = "bold", label.size = 0.25)

people_map_2018_60_all

ggsave("visual/people_map_2018_60_all.png", plot = people_map_2018_60_all, device = NULL, path = NULL,
  scale = 1, width = 50, height = 50, units = "cm",
  dpi = 600, limitsize = TRUE)

```

```{r, include=FALSE}
# dot-density map for 2018 (permit)

geo_people_2018_60_num <- geo_table_60_sf_full %>%
  st_set_geometry(NULL) %>%
  dplyr::select(geoid, count_permit_2018) 

num.dots <- dplyr::select(geo_people_2018_60_num, count_permit_2018)

num.dots

geo_people_2018_60_sp <- as(geo_table_60_sf_full, "Spatial")
class(geo_people_2018_60_sp)

sp.dfs <- lapply(names(num.dots), function(x) {
  dotsInPolys(geo_people_2018_60_sp, as.integer(num.dots[, x]), f="random")
})

dfs <- lapply(sp.dfs, function(x) {
  data.frame(coordinates(x)[,1:2])
})

dots.final <- bind_rows(dfs)

head(dots.final)

people_map_2018_60_permit <- ggplot() +
  geom_sf(data = boundary_city, fill = "white", color = 'grey', size = 0.5, alpha = 1, show.legend = FALSE) +
  geom_sf(data = geo_table_60_sf_full, fill = "white", color = 'white', size = .1, show.legend = TRUE, alpha = 0) +
  geom_sf(data = boundary_water_mass, fill = "grey50", color = 'grey', size = 0.5, alpha = 1, show.legend = FALSE) +
  geom_sf(data = boundary_water_nhri, fill = "grey50", color = 'grey', size = 0.5, alpha = 1, show.legend = FALSE) +
  geom_sf(data = boundary_water_ct, fill = "grey50", color = 'grey', size = 0.5, alpha = 1, show.legend = FALSE) +
  geom_sf(data = highway_mass, fill = "white", color = 'grey', size = 1, alpha = 0, show.legend = FALSE) +
  geom_sf(data = driving_60_sf, fill = "white", color = "#e42f3f", size = 0.5, show.legend = TRUE, alpha = 0) +
  coord_sf(xlim = c(-72.14123, -70.54279 ), ylim = c(41.67098, 43.07718)) +
  geom_point(data = dots.final, aes(x, y), colour = "purple", alpha = 0.10) +
  geom_label(data = city_centroids, aes(X, Y, label = name), fill = "black", colour = "white", fontface = "bold", label.size = 0.25)

people_map_2018_60_permit

ggsave("visual/people_map_2018_60_permit_191215.png", plot = people_map_2018_60_permit, device = NULL, path = NULL,
  scale = 1, width = 50, height = 50, units = "cm",
  dpi = 600, limitsize = TRUE)

```

```{r, include=FALSE}
# dot-density map for 2019 (affiliations)

people_table_2018
distinct(people_table_2018, affiliation, .keep_all = FALSE)

people_table_2018 %>%
  filter((!is.na(geoid)))

people_table_2018_forjoin_emp <- people_table_2018 %>%
  filter((!is.na(geoid)) & affiliation == 'Employee') %>%
  group_by(geoid) %>%
  summarise(count_2018_emp = n()) %>%
  arrange(desc(count_2018_emp)) 

people_table_2018_forjoin_fac <- people_table_2018 %>%
  filter((!is.na(geoid)) & affiliation == 'Faculty') %>%
  group_by(geoid) %>%
  summarise(count_2018_fac = n()) %>%
  arrange(desc(count_2018_fac)) 

people_table_2018_forjoin_stu <- people_table_2018 %>%
  filter((!is.na(geoid)) & affiliation == 'Student') %>%
  group_by(geoid) %>%
  summarise(count_2018_stu = n()) %>%
  arrange(desc(count_2018_stu)) 

# build employee dot data
geo_people_2018_emp <- geo_table_60_sf %>%
  inner_join(people_table_2018_forjoin_emp, by = 'geoid') %>%
  mutate(count_2018_emp = as.numeric(count_2018_emp))

sum(geo_people_2018_emp$count_2018_emp)
10466

geo_people_2018_emp_sp <- as(geo_people_2018_emp, "Spatial")
class(geo_people_2018_emp)

geo_people_2018_emp_num <- geo_people_2018_emp %>%
  st_set_geometry(NULL) %>%
  dplyr::select(geoid, count_2018_emp) 

num.dots <- select(geo_people_2018_emp_num, count_2018_emp)

num.dots

sp.dfs <- lapply(names(num.dots), function(x) {
  dotsInPolys(geo_people_2018_emp_sp, as.integer(num.dots[, x]), f="random")
})

dfs <- lapply(sp.dfs, function(x) {
  data.frame(coordinates(x)[,1:2])
})

dots.final_emp <- bind_rows(dfs)

head(dots.final_emp)

# build faculty dot data
geo_people_2018_fac <- geo_table_60_sf %>%
  inner_join(people_table_2018_forjoin_fac, by = 'geoid') %>%
  mutate(count_2018_fac = as.numeric(count_2018_fac))

sum(geo_people_2018_fac$count_2018_fac)
# 12029/12294 = 97.8% of the employees/faculties with geoid are in the top 11 state
# 11474/12294 = 93.3% of the employees/faculties with geoid live within 1 hour driving area

geo_people_2018_fac_sp <- as(geo_people_2018_fac, "Spatial")
class(geo_people_2018_fac)

geo_people_2018_fac_num <- geo_people_2018_fac %>%
  st_set_geometry(NULL) %>%
  dplyr::select(geoid, count_2018_fac) 

num.dots <- log(select(geo_people_2018_fac_num, count_2018_fac)) *10

num.dots

sp.dfs <- lapply(names(num.dots), function(x) {
  dotsInPolys(geo_people_2018_fac_sp, as.integer(num.dots[, x]), f="random")
})

dfs <- lapply(sp.dfs, function(x) {
  data.frame(coordinates(x)[,1:2])
})

dots.final_fac <- bind_rows(dfs)

head(dots.final_fac)

# build student dot data
geo_people_2018_stu <- geo_table_60_sf %>%
  inner_join(people_table_2018_forjoin_stu, by = 'geoid') %>%
  mutate(count_2018_stu = as.numeric(count_2018_stu))

geo_people_2018_stu_sp <- as(geo_people_2018_stu, "Spatial")
class(geo_people_2018_stu)

geo_people_2018_stu_num <- geo_people_2018_stu %>%
  st_set_geometry(NULL) %>%
  dplyr::select(geoid, count_2018_stu) 

num.dots <- log(select(geo_people_2018_stu_num, count_2018_stu)) *10

num.dots

sp.dfs <- lapply(names(num.dots), function(x) {
  dotsInPolys(geo_people_2018_stu_sp, as.integer(num.dots[, x]), f="random")
})

dfs <- lapply(sp.dfs, function(x) {
  data.frame(coordinates(x)[,1:2])
})

dots.final_stu <- bind_rows(dfs)

head(dots.final_stu)

# create the affiliation dot density map
people_map_2018_60_affiliations <- ggplot() +
  geom_sf(data = boundary_city, fill = "white", color = 'grey', size = 0.5, alpha = 1, show.legend = FALSE) +
  geom_sf(data = geo_people_2018_60, fill = "white", color = 'white', size = .1, show.legend = TRUE) +
  geom_sf(data = boundary_water_mass, fill = "grey50", color = 'grey', size = 0.5, alpha = 1, show.legend = FALSE) +
  geom_sf(data = boundary_water_nhri, fill = "grey50", color = 'grey', size = 0.5, alpha = 1, show.legend = FALSE) +
  geom_sf(data = boundary_water_ct, fill = "grey50", color = 'grey', size = 0.5, alpha = 1, show.legend = FALSE) +
  geom_sf(data = highway_mass, fill = "white", color = 'grey', size = 1, alpha = 0, show.legend = FALSE) +
  geom_sf(data = driving_60_sf, fill = "white", color = "#e42f3f", size = 0.5, show.legend = TRUE, alpha = 0) +
  coord_sf(xlim = c(-72.14123, -70.54279 ), ylim = c(41.67098, 43.07718)) +
  geom_point(data = dots.final_emp, aes(x, y, colour = 'employee'), alpha = 0.10) +
  geom_point(data = dots.final_fac, aes(x, y, colour = 'faculty'), alpha = 0.10) +
  geom_point(data = dots.final_stu, aes(x, y, colour = 'student'), alpha = 0.05) +
  scale_color_manual(values = c('student' = '#b62367', 'employee' = '#38835b', 'faculty' = '#e17002')) +
  geom_label(data = city_centroids, aes(X, Y, label = name), fill = "black", colour = "white", fontface = "bold", label.size = 0.15)

people_map_2018_60_affiliations

ggsave("visual/people_map_2018_60_affiliations.png", plot = people_map_2018_60_affiliations, device = NULL, path = NULL,
  scale = 1, width = 30, height = 30, units = "cm",
  dpi = 300, limitsize = TRUE)

# create the affiliation dot density map (only employees and faculties)
people_map_2018_60_affiliations_ef <- ggplot() +
  geom_sf(data = boundary_city, fill = "white", color = 'grey', size = 0.5, alpha = 1, show.legend = FALSE) +
  geom_sf(data = geo_people_2018_60, fill = "white", color = 'white', size = .1, show.legend = TRUE) +
  geom_sf(data = boundary_water_mass, fill = "grey50", color = 'grey', size = 0.5, alpha = 1, show.legend = FALSE) +
  geom_sf(data = boundary_water_nhri, fill = "grey50", color = 'grey', size = 0.5, alpha = 1, show.legend = FALSE) +
  geom_sf(data = boundary_water_ct, fill = "grey50", color = 'grey', size = 0.5, alpha = 1, show.legend = FALSE) +
  geom_sf(data = highway_mass, fill = "white", color = 'grey', size = 1, alpha = 0, show.legend = FALSE) +
  geom_sf(data = driving_60_sf, fill = "white", color = "#e42f3f", size = 0.5, show.legend = TRUE, alpha = 0) +
  coord_sf(xlim = c(-72.14123, -70.54279 ), ylim = c(41.67098, 43.07718)) +
  geom_point(data = dots.final_emp, aes(x, y, colour = 'employee'), alpha = 0.10) +
  geom_point(data = dots.final_fac, aes(x, y, colour = 'faculty'), alpha = 0.10) +
  scale_color_manual(values = c('employee' = '#38835b', 'faculty' = '#e17002')) +
  geom_label(data = city_centroids, aes(X, Y, label = name), fill = "black", colour = "white", fontface = "bold", label.size = 0.15)

people_map_2018_60_affiliations_ef

ggsave("visual/people_map_2018_60_affiliations_ef.png", plot = people_map_2018_60_affiliations_ef, device = NULL, path = NULL,
  scale = 1, width = 30, height = 30, units = "cm",
  dpi = 300, limitsize = TRUE)

```


******************* dot-density map for small scale *******************


```{r, include=FALSE}
# dot-density map for 2018 (all)

geo_people_2018_30 <- geo_table_30_sf %>%
  inner_join(people_table_2018_forjoin, by = 'geoid') %>%
  mutate(count_2018 = as.numeric(count_2018))

geo_people_2018_30
class(geo_people_2018_30)

sum(geo_people_2018_30$count_2018)

# 26726/27187 = 98.3% of the employees/students with geoid are in the top 11 state
# 25696/27187 = 94.5% of the employees/students with geoid live within 1 hour driving area
# 22375/27187 = 82.3% of the employees/students with geoid live within 0.5 hour driving area

geo_people_2018_30_num <- geo_people_2018_30 %>%
  st_set_geometry(NULL) %>%
  dplyr::select(geoid, count_2018) 

num.dots <- select(geo_people_2018_30_num, count_2018)

num.dots

geo_people_2018_30_sp <- as(geo_people_2018_30, "Spatial")
class(geo_people_2018_30_sp)

sp.dfs <- lapply(names(num.dots), function(x) {
  dotsInPolys(geo_people_2018_30_sp, as.integer(num.dots[, x]), f="random")
})

dfs <- lapply(sp.dfs, function(x) {
  data.frame(coordinates(x)[,1:2])
})

dots.final <- bind_rows(dfs)

head(dots.final)

people_map_2018_30_all <- ggplot() +
  geom_sf(data = boundary_city, fill = "white", color = 'grey', size = 0.5, alpha = 1, show.legend = FALSE) +
  geom_sf(data = geo_people_2018_30, fill = "white", color = 'white', size = .1, show.legend = TRUE, alpha = 0) +
  geom_sf(data = boundary_water_mass, fill = "grey50", color = 'grey', size = 0.5, alpha = 1, show.legend = FALSE) +
  geom_sf(data = boundary_water_nhri, fill = "grey50", color = 'grey', size = 0.5, alpha = 1, show.legend = FALSE) +
  geom_sf(data = boundary_water_ct, fill = "grey50", color = 'grey', size = 0.5, alpha = 1, show.legend = FALSE) +
  geom_sf(data = highway_mass, fill = "white", color = 'grey', size = 1, alpha = 0, show.legend = FALSE) +
  geom_sf(data = driving_30_sf, fill = "white", color = "#e42f3f", size = 0.5, show.legend = TRUE, alpha = 0) +
  coord_sf(xlim = c(-71.56551, -70.85817), ylim = c(42.09288, 42.69501)) +
  geom_point(data = dots.final, aes(x, y), colour = "#007fb0", alpha = 0.10) +
  geom_label(data = city_centroids, aes(X, Y, label = name), fill = "black", colour = "white", fontface = "bold", label.size = 0.25)

people_map_2018_30_all

ggsave("visual/people_map_2018_30_all.png", plot = people_map_2018_30_all, device = NULL, path = NULL,
  scale = 1, width = 50, height = 50, units = "cm",
  dpi = 600, limitsize = TRUE)

```

```{r, include=FALSE}
# dot-density map for 2018 (permit)

geo_people_2018_30_num <- geo_table_30_sf_full %>%
  st_set_geometry(NULL) %>%
  dplyr::select(geoid, count_permit_2018) 

num.dots <- dplyr::select(geo_people_2018_30_num, count_permit_2018)

num.dots

geo_people_2018_30_sp <- as(geo_table_30_sf_full, "Spatial")
class(geo_people_2018_30_sp)

sp.dfs <- lapply(names(num.dots), function(x) {
  dotsInPolys(geo_people_2018_30_sp, as.integer(num.dots[, x]), f="random")
})

dfs <- lapply(sp.dfs, function(x) {
  data.frame(coordinates(x)[,1:2])
})

dots.final <- bind_rows(dfs)

head(dots.final)

people_map_2018_30_permit <- ggplot() +
  geom_sf(data = boundary_city, fill = "white", color = 'grey', size = 0.5, alpha = 1, show.legend = FALSE) +
  geom_sf(data = geo_table_30_sf_full, fill = "white", color = 'white', size = .1, show.legend = TRUE, alpha = 0) +
  geom_sf(data = boundary_water_mass, fill = "grey50", color = 'grey', size = 0.5, alpha = 1, show.legend = FALSE) +
  geom_sf(data = boundary_water_nhri, fill = "grey50", color = 'grey', size = 0.5, alpha = 1, show.legend = FALSE) +
  geom_sf(data = boundary_water_ct, fill = "grey50", color = 'grey', size = 0.5, alpha = 1, show.legend = FALSE) +
  geom_sf(data = highway_mass, fill = "white", color = 'grey', size = 1, alpha = 0, show.legend = FALSE) +
  geom_sf(data = driving_30_sf, fill = "white", color = "#e42f3f", size = 0.5, show.legend = TRUE, alpha = 0) +
  coord_sf(xlim = c(-71.56551, -70.85817), ylim = c(42.09288, 42.69501)) +
  geom_point(data = dots.final, aes(x, y), colour = "purple", alpha = 0.10) +
  geom_label(data = city_centroids, aes(X, Y, label = name), fill = "black", colour = "white", fontface = "bold", label.size = 0.25)

people_map_2018_30_permit

ggsave("visual/people_map_2018_30_permit_191215.png", plot = people_map_2018_30_permit, device = NULL, path = NULL,
  scale = 1, width = 50, height = 50, units = "cm",
  dpi = 600, limitsize = TRUE)

```

```{r, include=FALSE}
# dot-density map for 2019 (affiliations)

# build employee dot data

geo_people_2018_emp <- geo_table_30_sf %>%
  inner_join(people_table_2018_forjoin_emp, by = 'geoid') %>%
  mutate(count_2018_emp = as.numeric(count_2018_emp))

sum(geo_people_2018_emp$count_2018_emp)

geo_people_2018_emp_sp <- as(geo_people_2018_emp, "Spatial")
class(geo_people_2018_emp)

geo_people_2018_emp_num <- geo_people_2018_emp %>%
  st_set_geometry(NULL) %>%
  dplyr::select(geoid, count_2018_emp) 

num.dots <- select(geo_people_2018_emp_num, count_2018_emp)

num.dots

sp.dfs <- lapply(names(num.dots), function(x) {
  dotsInPolys(geo_people_2018_emp_sp, as.integer(num.dots[, x]), f="random")
})

dfs <- lapply(sp.dfs, function(x) {
  data.frame(coordinates(x)[,1:2])
})

dots.final_emp <- bind_rows(dfs)

head(dots.final_emp)

# build faculty dot data
geo_people_2018_fac <- geo_table_30_sf %>%
  inner_join(people_table_2018_forjoin_fac, by = 'geoid') %>%
  mutate(count_2018_fac = as.numeric(count_2018_fac))

sum(geo_people_2018_fac$count_2018_fac)
# 12029/12294 = 97.8% of the employees/faculties with geoid are in the top 11 state
# 11474/12294 = 93.3% of the employees/faculties with geoid live within 1 hour driving area
# 9856/12294 = 80.2% of the employees/faculties with geoid live within 0.5 hour driving area

geo_people_2018_fac_sp <- as(geo_people_2018_fac, "Spatial")
class(geo_people_2018_fac)

geo_people_2018_fac_num <- geo_people_2018_fac %>%
  st_set_geometry(NULL) %>%
  dplyr::select(geoid, count_2018_fac) 

num.dots <- log(select(geo_people_2018_fac_num, count_2018_fac)) *10

num.dots

sp.dfs <- lapply(names(num.dots), function(x) {
  dotsInPolys(geo_people_2018_fac_sp, as.integer(num.dots[, x]), f="random")
})

dfs <- lapply(sp.dfs, function(x) {
  data.frame(coordinates(x)[,1:2])
})

dots.final_fac <- bind_rows(dfs)

head(dots.final_fac)

# build student dot data
geo_people_2018_stu <- geo_table_30_sf %>%
  inner_join(people_table_2018_forjoin_stu, by = 'geoid') %>%
  mutate(count_2018_stu = as.numeric(count_2018_stu))

geo_people_2018_stu_sp <- as(geo_people_2018_stu, "Spatial")
class(geo_people_2018_stu)

geo_people_2018_stu_num <- geo_people_2018_stu %>%
  st_set_geometry(NULL) %>%
  dplyr::select(geoid, count_2018_stu) 

num.dots <- log(select(geo_people_2018_stu_num, count_2018_stu)) *10

num.dots

sp.dfs <- lapply(names(num.dots), function(x) {
  dotsInPolys(geo_people_2018_stu_sp, as.integer(num.dots[, x]), f="random")
})

dfs <- lapply(sp.dfs, function(x) {
  data.frame(coordinates(x)[,1:2])
})

dots.final_stu <- bind_rows(dfs)

head(dots.final_stu)

# create the affiliation dot density map
people_map_2018_30_affiliations <- ggplot() +
  geom_sf(data = boundary_city, fill = "white", color = 'grey', size = 0.5, alpha = 1, show.legend = FALSE) +
  geom_sf(data = geo_people_2018_30, fill = "white", color = 'white', size = .1, show.legend = TRUE) +
  geom_sf(data = boundary_water_mass, fill = "grey50", color = 'grey', size = 0.5, alpha = 1, show.legend = FALSE) +
  geom_sf(data = boundary_water_nhri, fill = "grey50", color = 'grey', size = 0.5, alpha = 1, show.legend = FALSE) +
  geom_sf(data = boundary_water_ct, fill = "grey50", color = 'grey', size = 0.5, alpha = 1, show.legend = FALSE) +
  geom_sf(data = highway_mass, fill = "white", color = 'grey', size = 1, alpha = 0, show.legend = FALSE) +
  geom_sf(data = driving_30_sf, fill = "white", color = "#e42f3f", size = 0.5, show.legend = TRUE, alpha = 0) +
  coord_sf(xlim = c(-71.56551, -70.85817), ylim = c(42.09288, 42.69501)) +
  geom_point(data = dots.final_emp, aes(x, y, colour = 'employee'), alpha = 0.20) +
  geom_point(data = dots.final_fac, aes(x, y, colour = 'faculty'), alpha = 0.20) +
  geom_point(data = dots.final_stu, aes(x, y, colour = 'student'), alpha = 0.10) +
  scale_color_manual(values = c('student' = '#b62367', 'employee' = '#38835b', 'faculty' = '#e17002')) +
  geom_label(data = city_centroids, aes(X, Y, label = name), fill = "black", colour = "white", fontface = "bold", label.size = 0.25)

people_map_2018_30_affiliations

ggsave("visual/people_map_2018_30_affiliations.png", plot = people_map_2018_30_affiliations, device = NULL, path = NULL,
  scale = 1, width = 50, height = 50, units = "cm",
  dpi = 600, limitsize = TRUE)

# create the affiliation dot density map (only employees and faculties)
people_map_2018_30_affiliations_ef <- ggplot() +
  geom_sf(data = boundary_city, fill = "white", color = 'grey', size = 0.5, alpha = 1, show.legend = FALSE) +
  geom_sf(data = geo_people_2018_30, fill = "white", color = 'white', size = .1, show.legend = TRUE) +
  geom_sf(data = boundary_water_mass, fill = "grey50", color = 'grey', size = 0.5, alpha = 1, show.legend = FALSE) +
  geom_sf(data = boundary_water_nhri, fill = "grey50", color = 'grey', size = 0.5, alpha = 1, show.legend = FALSE) +
  geom_sf(data = boundary_water_ct, fill = "grey50", color = 'grey', size = 0.5, alpha = 1, show.legend = FALSE) +
  geom_sf(data = highway_mass, fill = "white", color = 'grey', size = 1, alpha = 0, show.legend = FALSE) +
  geom_sf(data = driving_30_sf, fill = "white", color = "#e42f3f", size = 0.5, show.legend = TRUE, alpha = 0) +
  coord_sf(xlim = c(-71.56551, -70.85817), ylim = c(42.09288, 42.69501)) +
  geom_point(data = dots.final_emp, aes(x, y, colour = 'employee'), alpha = 0.20) +
  geom_point(data = dots.final_fac, aes(x, y, colour = 'faculty'), alpha = 0.20) +
  scale_color_manual(values = c('employee' = '#38835b', 'faculty' = '#e17002')) +
  geom_label(data = city_centroids, aes(X, Y, label = name), fill = "black", colour = "white", fontface = "bold", label.size = 0.25)

people_map_2018_30_affiliations_ef

ggsave("visual/people_map_2018_30_affiliations_ef.png", plot = people_map_2018_30_affiliations_ef, device = NULL, path = NULL,
  scale = 1, width = 50, height = 50, units = "cm",
  dpi = 600, limitsize = TRUE)

```

## Section1: Where does the MIT community live?

This section will show the pattern of the living address of the MIT community in three scale (top 11 states, 60-minute drive, 30-minute drive). At each scale, two maps will be presented, first one shows the pattern of the overall community, second one is colored by their MIT affiliation (employee, faculty, student).

## 26726/27187 = 98.3% of the employees/faculties/students with geoid live in the top 11 state

## map1
```{r large scale map1}

people_map_2018_all

```

## map2
```{r large scale map2}

people_map_2018_affiliations

```

## 25696/27187 = 94.5% of the employees/faculties/students with geoid live within 1 hour driving area

## map1
```{r medium scale map1}

people_map_2018_60_all

```

## map2
```{r medium scale map2}

people_map_2018_60_affiliations

```

## 22375/27187 = 82.3% of the employees/faculties/students with geoid live within 0.5 hour driving area

## map1
```{r small scale map1}

people_map_2018_30_all

```

## map2
```{r small scale map2}

people_map_2018_30_affiliations

```